import {useFrame, useLoader} from "@react-three/fiber"
import {useEffect, useRef, useState} from "react"
import {a} from "@react-spring/three"
import * as THREE from "three"
import {GLTFLoader} from "three/examples/jsm/loaders/GLTFLoader"
import useStore from "../../states/modelState"
import Decals, {createDecal} from "./Decals"
import useDecalStore from "@/states/decalState";
import {process_image} from "@/lib/imageUtils";
import useMobileDetect from "@/components/UseMobileDetect";

const ShirtModel = ({modelRef, groupRef, url, rotation, setModelRayData}) => {

    // GLOBAL STATE
    const {
        animation,
        decals,
        addDecal,
        decalPath,
        decalName,
        decalSize,
        initialDecalSize,
        modelColor,
        setDecalPath,
        addDecalImages,
        setDecalSize,
        setDecalName,
        scale,
        placeDecal,
        setPlaceDecal,
        removeDecal
    } = useStore()

    const {addDecalData} = useDecalStore()
    const [event, setEvent] = useState({})

    // STATE
    const timestamp = useRef(window.performance.now())

    // ANIMATE
    useFrame(() => {
        if (animation === "animation_360") {
            groupRef.current.rotation.y += (Math.PI * 2) / (60 * 7)
        }
    })
    useEffect(() => {
        if (!animation) groupRef.current.rotation.y = 0
    }, [animation])

    useEffect(() => {
        // Center the geometry
        modelRef.current.geometry.center();
    }, []);

    useEffect(() => {
        if (!placeDecal && decalPath === null) return
        if (event.intersections === undefined) return;
        handleDecal(event)
        setEvent({})
        setPlaceDecal(false)
    }, [placeDecal])

    // LOAD MODEL
    const gltf = useLoader(GLTFLoader, url)
    // ADD DECAL TO ARRAY
    const handleDecal = (e) => {
        if (decalPath === null) return
        // Get texture
        process_image(decalPath).then(image => {
            new THREE.TextureLoader().load(image, (decalTexture) => {
                const {x: x1, y: y1, z: z1} = e.intersections[0].point
                const {x: x2, y: y2, z: z2} = modelRef.current.localToWorld(e.intersections[0].face.normal)

                console.clear()
                console.log("POINT:", {
                    x1, y1, z1
                })

                const {decal, key} = createDecal(modelRef.current, // Geometry
                    new THREE.Vector3(x1, y1, z1), // Position
                    new THREE.Vector3(x2, y2, z2), // Normal
                    decalTexture, // Texture
                    decalSize // Size of longest side
                )

                const obj = {
                    key: key,
                    model: {...modelRef.current},
                    position: {x: x1, y: y1, z: z1},
                    normal: {x: x2, y: y2, z: z2},
                    texture: image,
                    textureName: decalName,
                    size: decalSize
                }

                addDecalData(obj)

                // Add decal to decal manager
                addDecalImages({path: image, name: decalName, key: key})

                // Add decal to state
                addDecal({mesh: decal, key: key})

                // Remove decal for one time use
                setDecalPath(null)
                setDecalName(null)

                // Reset decal size
                setDecalSize(initialDecalSize)
            })
        })
    }

    // PASS RAYCAST
    const passRaycast = (e) => {
        console.clear()
        console.log("Event:", e)
        // Only submit while decal is active
        if (decalPath) {
            setEvent(e)
            if (timestamp.current + 16 <= window.performance.now()) {
                // DEBOUNCE: Update timestamp for new interval
                timestamp.current = window.performance.now()

                // Get position
                const posV = e.point.clone()

                // Get world normal
                const n = e.face.normal.clone()
                const nWorld = modelRef.current.localToWorld(n)

                // Set pos and normal
                setModelRayData({position: posV, normalWorld: nWorld})
            }
        }
    }

    // RESET RAYCAST POS AND NORMAL
    const removeRaycast = () => setModelRayData(null)

    const {isMobile} = useMobileDetect()

    return (
        <a.group ref={groupRef} rotation={rotation} castShadow scale={scale}>
            <mesh
                ref={modelRef}
                onPointerMove={passRaycast}
                onPointerOut={removeRaycast}
                onPointerDown={isMobile() ? passRaycast : handleDecal}
                geometry={gltf.scene.children[0].geometry}
                castShadow
            >
                <meshStandardMaterial
                    color={modelColor}
                />
            </mesh>
            <Decals decals={decals}/>
        </a.group>
    )
}

export default ShirtModel
